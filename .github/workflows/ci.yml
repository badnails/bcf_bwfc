name: CI

on:
  push:
    branches: [main, shashwoto]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies (Order Service)
        working-directory: ./order-service
        run: bun install

      - name: Install dependencies (Inventory Service)
        working-directory: ./inventory-service
        run: bun install

      - name: Type check (Order Service)
        working-directory: ./order-service
        run: bun run tsc --noEmit || echo "No tsconfig found, skipping type check"

      - name: Type check (Inventory Service)
        working-directory: ./inventory-service
        run: bun run tsc --noEmit || echo "No tsconfig found, skipping type check"

      - name: Build check (Order Service)
        working-directory: ./order-service
        run: bun build src/index.ts --outdir ./dist --target bun

      - name: Build check (Inventory Service)
        working-directory: ./inventory-service
        run: bun build src/index.ts --outdir ./dist --target bun

  docker-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Order Service Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./order-service
          file: ./order-service/Dockerfile
          push: false
          tags: order-service:ci

      - name: Build Inventory Service Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./inventory-service
          file: ./inventory-service/Dockerfile
          push: false
          tags: inventory-service:ci

  docker-compose-test:
    runs-on: ubuntu-latest
    needs: docker-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services with Docker Compose
        run: docker compose up -d --build

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 15

      - name: Health check - Order Service
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "✅ Order Service is healthy"
          else
            echo "❌ Order Service health check failed (HTTP $response)"
            docker compose logs order-service
            exit 1
          fi

      - name: Health check - Inventory Service
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "✅ Inventory Service is healthy"
          else
            echo "❌ Inventory Service health check failed (HTTP $response)"
            docker compose logs inventory-service
            exit 1
          fi

      - name: Test Order API
        run: |
          # Test GET orders
          curl -f http://localhost:3000/api/orders || exit 1
          echo "✅ GET /api/orders works"
          
          # Test POST order
          response=$(curl -s -X POST http://localhost:3000/api/orders \
            -H "Content-Type: application/json" \
            -d '{"product_id":"PROD-001","quantity":1}')
          echo "Order response: $response"
          echo "✅ POST /api/orders works"

      - name: Test Inventory API
        run: |
          # Test GET inventory
          curl -f http://localhost:3001/api/inventory || exit 1
          echo "✅ GET /api/inventory works"

      - name: Cleanup
        if: always()
        run: docker compose down -v
